import{d as ne,P as L,h as _,Z as De,r as d,Q as Ae,c as k,o as c,b as e,w as t,F as A,f as $,g as T,_ as $e,u as g,x as le,e as n,E as te,W as Be,t as r,ay as Ne,as as Ee,U as qe,a as b,bu as Re,$ as je,bs as Fe,bx as Me,R as K,N as w,a0 as Pe}from"./index-Bo6A_Mt9.js";import{u as Ie}from"./useHandleData-CAIr8DwC.js";import{i as Le,j as Ke,k as Oe,l as He,u as ae,m as oe,n as Qe,o as We}from"./sms-Do47znH-.js";import{_ as Ze}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ge={class:"sms-templates"},Je={class:"table-header"},Xe={class:"table-title"},Ye={class:"table-actions"},el={class:"variables-container"},ll={class:"content-info"},tl={key:0,class:"preview-container"},al={class:"sms-preview"},ol={class:"sms-bubble"},nl={class:"sms-info"},sl={key:0,class:"warning"},dl=ne({name:"SmsTemplates"}),rl=ne({...dl,setup(il){const i=L({template_code:"",country_code:"",is_active:"",keyword:""}),u=L({page:1,page_size:20,total:0}),O=_([]),q=_(!1),R=_(!1),j=_([]),F=_([]),C=_(!1),M=_("新建短信模板"),S=_(!1),B=_(),P=_(!1),s=L({id:null,template_code:"picking",country_code:"en",template_name:"",content:"",description:"",is_active:!0,sort_order:0}),se=["customer_name","order_number","product_title","tracking_number","quantity","total_amount","address","city","province"],de={template_code:[{required:!0,message:"请选择模板类型",trigger:"change"}],country_code:[{required:!0,message:"请选择国家/语言",trigger:"change"}],template_name:[{required:!0,message:"请输入模板名称",trigger:"blur"}],content:[{required:!0,message:"请输入短信内容",trigger:"blur"},{max:1e3,message:"短信内容不能超过1000字符",trigger:"blur"}]},I=_(!1),p=_(null),re={picking:"拣货通知",shipped:"发货通知",arrival:"到达提醒",reshipment:"补发通知"},ie={picking:"warning",shipped:"success",arrival:"primary",reshipment:"danger"},H=o=>re[o]||o,Q=o=>ie[o]||"info",V=async()=>{q.value=!0;try{const o={page:u.page,page_size:u.page_size,...i},{data:l}=await Le(o);O.value=l.list,u.total=l.pagination.total}catch(o){console.error("加载数据失败:",o),w.error("加载数据失败")}finally{q.value=!1}},ue=async()=>{try{const{data:o}=await Ke();j.value=o}catch(o){console.error("加载模板代码失败:",o)}},pe=async()=>{try{const{data:o}=await Oe();F.value=o}catch(o){console.error("加载国家代码失败:",o)}},W=()=>{u.page=1,V()},ce=()=>{i.template_code="",i.country_code="",i.is_active="",i.keyword="",u.page=1,V()},me=o=>{u.page=o,V()},_e=o=>{u.page_size=o,u.page=1,V()},fe=async()=>{try{await Pe.confirm("初始化默认模板将为所有国家/语言创建标准短信模板，确定要继续吗？","初始化确认",{confirmButtonText:"确定初始化",cancelButtonText:"取消",type:"warning"}),R.value=!0,await He(),w.success("默认模板初始化成功"),V()}catch(o){o!=="cancel"&&(console.error("初始化失败:",o),w.error(o.message||"初始化默认模板失败"))}finally{R.value=!1}},ge=async o=>{try{await ae(o.id,{template_code:o.template_code,country_code:o.country_code,template_name:o.template_name,content:o.content,is_active:o.is_active?1:0}),w.success("状态更新成功")}catch(l){console.error("状态更新失败:",l),w.error("状态更新失败"),o.is_active=!o.is_active}},ve=()=>{S.value=!1,M.value="新建短信模板",C.value=!0},ye=async o=>{S.value=!0,M.value="编辑短信模板";try{const{data:l}=await oe(o.id);Object.assign(s,l),C.value=!0}catch(l){console.error("加载模板详情失败:",l),w.error("加载模板详情失败")}},be=async o=>{try{const{data:l}=await oe(o.id);p.value=l,I.value=!0}catch(l){console.error("加载模板详情失败:",l),w.error("加载模板详情失败")}},we=async o=>{await Ie(()=>Qe(o.id),`确定要删除模板 "${o.template_name}" 吗？`,"删除成功"),V()},Ve=async()=>{B.value&&await B.value.validate(async o=>{if(o){P.value=!0;try{const l={...s};S.value&&l.id?(await ae(l.id,l),w.success("更新成功")):(await We(l),w.success("创建成功")),C.value=!1,V()}catch(l){console.error("提交失败:",l),w.error(l.message||"操作失败")}finally{P.value=!1}}})},he=()=>{var o;(o=B.value)==null||o.resetFields(),Object.assign(s,{id:null,template_code:"picking",country_code:"en",template_name:"",content:"",description:"",is_active:!0,sort_order:0})},ke=o=>{s.content+=`{${o}}`};return De(()=>{V(),ue(),pe()}),(o,l)=>{const z=d("el-option"),D=d("el-select"),m=d("el-form-item"),f=d("el-icon"),N=d("el-input"),v=d("el-button"),Z=d("el-form"),G=d("el-card"),h=d("el-tag"),y=d("el-table-column"),J=d("el-switch"),Ce=d("el-table"),ze=d("el-pagination"),E=d("el-col"),X=d("el-row"),xe=d("el-input-number"),Y=d("el-text"),ee=d("el-dialog"),x=d("el-descriptions-item"),Ue=d("el-descriptions"),Te=d("el-divider"),Se=Ae("loading");return c(),k("div",Ge,[e(G,{class:"search-card",shadow:"never"},{default:t(()=>[e(Z,{model:i,inline:"",class:"search-form"},{default:t(()=>[e(m,{label:"模板类型"},{default:t(()=>[e(D,{modelValue:i.template_code,"onUpdate:modelValue":l[0]||(l[0]=a=>i.template_code=a),placeholder:"请选择类型",clearable:"",style:{width:"180px"}},{default:t(()=>[(c(!0),k(A,null,$(j.value,a=>(c(),T(z,{key:a.template_code,label:a.description,value:a.template_code},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(m,{label:"国家/语言"},{default:t(()=>[e(D,{modelValue:i.country_code,"onUpdate:modelValue":l[1]||(l[1]=a=>i.country_code=a),placeholder:"请选择",clearable:"",style:{width:"180px"}},{default:t(()=>[(c(!0),k(A,null,$(F.value,a=>(c(),T(z,{key:a.code,label:a.name,value:a.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(m,{label:"状态"},{default:t(()=>[e(D,{modelValue:i.is_active,"onUpdate:modelValue":l[2]||(l[2]=a=>i.is_active=a),placeholder:"请选择状态",clearable:"",style:{width:"100px"}},{default:t(()=>[e(z,{label:"启用",value:1}),e(z,{label:"禁用",value:0})]),_:1},8,["modelValue"])]),_:1}),e(m,{label:"关键词"},{default:t(()=>[e(N,{modelValue:i.keyword,"onUpdate:modelValue":l[3]||(l[3]=a=>i.keyword=a),placeholder:"搜索模板名称或内容",clearable:"",style:{width:"200px"},onKeyup:$e(W,["enter"])},{prefix:t(()=>[e(f,null,{default:t(()=>[e(g(le))]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(m,null,{default:t(()=>[e(v,{type:"primary",onClick:W},{default:t(()=>[e(f,null,{default:t(()=>[e(g(le))]),_:1}),l[16]||(l[16]=n(" 搜索 ",-1))]),_:1}),e(v,{onClick:ce},{default:t(()=>[e(f,null,{default:t(()=>[e(g(te))]),_:1}),l[17]||(l[17]=n(" 重置 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),e(G,{class:"table-card",shadow:"never"},{header:t(()=>[b("div",Je,[b("div",Xe,[e(f,{class:"title-icon"},{default:t(()=>[e(g(Re))]),_:1}),l[18]||(l[18]=b("span",null,"短信模板管理",-1)),e(h,{type:"info",size:"small"},{default:t(()=>[n(r(u.total)+" 个模板",1)]),_:1})]),b("div",Ye,[e(v,{type:"primary",size:"small",onClick:ve},{default:t(()=>[e(f,null,{default:t(()=>[e(g(je))]),_:1}),l[19]||(l[19]=n(" 新建模板 ",-1))]),_:1}),e(v,{type:"success",size:"small",onClick:fe,loading:R.value},{default:t(()=>[e(f,null,{default:t(()=>[e(g(Fe))]),_:1}),l[20]||(l[20]=n(" 初始化默认模板 ",-1))]),_:1},8,["loading"]),e(v,{size:"small",onClick:V},{default:t(()=>[e(f,null,{default:t(()=>[e(g(te))]),_:1}),l[21]||(l[21]=n(" 刷新 ",-1))]),_:1})])])]),default:t(()=>[Be((c(),T(Ce,{data:O.value,border:"",stripe:""},{default:t(()=>[e(y,{prop:"id",label:"ID",width:"60",align:"center"}),e(y,{prop:"template_code",label:"模板类型",width:"120",align:"center"},{default:t(({row:a})=>[e(h,{type:Q(a.template_code),size:"small"},{default:t(()=>[n(r(H(a.template_code)),1)]),_:2},1032,["type"])]),_:1}),e(y,{prop:"country_code",label:"国家/语言",width:"100",align:"center"},{default:t(({row:a})=>[e(h,{size:"small",type:"info"},{default:t(()=>[n(r(a.country_code.toUpperCase()),1)]),_:2},1024)]),_:1}),e(y,{prop:"template_name",label:"模板名称","min-width":"200","show-overflow-tooltip":""}),e(y,{prop:"content",label:"短信内容","min-width":"300","show-overflow-tooltip":""}),e(y,{label:"字符数",width:"80",align:"center"},{default:t(({row:a})=>[e(h,{type:a.content_length>160?"warning":"success",size:"small"},{default:t(()=>[n(r(a.content_length),1)]),_:2},1032,["type"])]),_:1}),e(y,{prop:"is_active",label:"状态",width:"80",align:"center"},{default:t(({row:a})=>[e(J,{modelValue:a.is_active,"onUpdate:modelValue":U=>a.is_active=U,onChange:U=>ge(a)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),e(y,{prop:"sort_order",label:"排序",width:"70",align:"center"}),e(y,{prop:"updated_at",label:"更新时间",width:"160"}),e(y,{label:"操作",width:"180",fixed:"right",align:"center"},{default:t(({row:a})=>[e(v,{link:"",type:"primary",size:"small",onClick:U=>be(a)},{default:t(()=>[e(f,null,{default:t(()=>[e(g(Ne))]),_:1}),l[22]||(l[22]=n(" 预览 ",-1))]),_:1},8,["onClick"]),e(v,{link:"",type:"primary",size:"small",onClick:U=>ye(a)},{default:t(()=>[e(f,null,{default:t(()=>[e(g(Ee))]),_:1}),l[23]||(l[23]=n(" 编辑 ",-1))]),_:1},8,["onClick"]),e(v,{link:"",type:"danger",size:"small",onClick:U=>we(a)},{default:t(()=>[e(f,null,{default:t(()=>[e(g(qe))]),_:1}),l[24]||(l[24]=n(" 删除 ",-1))]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Se,q.value]]),e(ze,{"current-page":u.page,"onUpdate:currentPage":l[4]||(l[4]=a=>u.page=a),"page-size":u.page_size,"onUpdate:pageSize":l[5]||(l[5]=a=>u.page_size=a),total:u.total,"page-sizes":[20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:_e,onCurrentChange:me,class:"pagination"},null,8,["current-page","page-size","total"])]),_:1}),e(ee,{modelValue:C.value,"onUpdate:modelValue":l[14]||(l[14]=a=>C.value=a),title:M.value,width:"700px","close-on-click-modal":!1,onClosed:he},{footer:t(()=>[e(v,{onClick:l[13]||(l[13]=a=>C.value=!1)},{default:t(()=>[...l[27]||(l[27]=[n("取消",-1)])]),_:1}),e(v,{type:"primary",onClick:Ve,loading:P.value},{default:t(()=>[...l[28]||(l[28]=[n("确定",-1)])]),_:1},8,["loading"])]),default:t(()=>[e(Z,{model:s,rules:de,ref_key:"formRef",ref:B,"label-width":"120px"},{default:t(()=>[e(X,{gutter:20},{default:t(()=>[e(E,{span:12},{default:t(()=>[e(m,{label:"模板类型",prop:"template_code"},{default:t(()=>[e(D,{modelValue:s.template_code,"onUpdate:modelValue":l[6]||(l[6]=a=>s.template_code=a),placeholder:"请选择类型",disabled:S.value,style:{width:"100%"}},{default:t(()=>[(c(!0),k(A,null,$(j.value,a=>(c(),T(z,{key:a.template_code,label:a.description,value:a.template_code},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1}),e(E,{span:12},{default:t(()=>[e(m,{label:"国家/语言",prop:"country_code"},{default:t(()=>[e(D,{modelValue:s.country_code,"onUpdate:modelValue":l[7]||(l[7]=a=>s.country_code=a),placeholder:"请选择",disabled:S.value,style:{width:"100%"}},{default:t(()=>[(c(!0),k(A,null,$(F.value,a=>(c(),T(z,{key:a.code,label:a.name,value:a.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),e(X,{gutter:20},{default:t(()=>[e(E,{span:16},{default:t(()=>[e(m,{label:"模板名称",prop:"template_name"},{default:t(()=>[e(N,{modelValue:s.template_name,"onUpdate:modelValue":l[8]||(l[8]=a=>s.template_name=a),placeholder:"请输入模板名称"},null,8,["modelValue"])]),_:1})]),_:1}),e(E,{span:8},{default:t(()=>[e(m,{label:"排序",prop:"sort_order"},{default:t(()=>[e(xe,{modelValue:s.sort_order,"onUpdate:modelValue":l[9]||(l[9]=a=>s.sort_order=a),min:0,max:999,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(m,{label:"模板说明"},{default:t(()=>[e(N,{modelValue:s.description,"onUpdate:modelValue":l[10]||(l[10]=a=>s.description=a),placeholder:"请输入模板说明（可选）"},null,8,["modelValue"])]),_:1}),e(m,{label:"是否启用"},{default:t(()=>[e(J,{modelValue:s.is_active,"onUpdate:modelValue":l[11]||(l[11]=a=>s.is_active=a)},null,8,["modelValue"])]),_:1}),e(m,{label:"可用变量"},{default:t(()=>[b("div",el,[(c(),k(A,null,$(se,a=>e(h,{key:a,size:"small",class:"variable-tag",onClick:U=>ke(a)},{default:t(()=>[n(r("{"+a+"}"),1)]),_:2},1032,["onClick"])),64))]),e(Y,{type:"info",size:"small",class:"variable-tip"},{default:t(()=>[e(f,null,{default:t(()=>[e(g(Me))]),_:1}),l[25]||(l[25]=n(" 点击变量可插入到短信内容末尾 ",-1))]),_:1})]),_:1}),e(m,{label:"短信内容",prop:"content"},{default:t(()=>[e(N,{modelValue:s.content,"onUpdate:modelValue":l[12]||(l[12]=a=>s.content=a),type:"textarea",rows:6,placeholder:"请输入短信内容，可使用变量如：{customer_name}、{order_number} 等",maxlength:"1000","show-word-limit":""},null,8,["modelValue"]),b("div",ll,[e(h,{type:s.content.length>160?"warning":"success",size:"small"},{default:t(()=>[n(r(s.content.length)+" 字符 ",1)]),_:1},8,["type"]),s.content.length>160?(c(),T(Y,{key:0,type:"warning",size:"small"},{default:t(()=>[...l[26]||(l[26]=[n(" 超过160字符可能会被拆分成多条短信计费 ",-1)])]),_:1})):K("",!0)])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),e(ee,{modelValue:I.value,"onUpdate:modelValue":l[15]||(l[15]=a=>I.value=a),title:"短信模板预览",width:"600px"},{default:t(()=>[p.value?(c(),k("div",tl,[e(Ue,{column:2,border:""},{default:t(()=>[e(x,{label:"模板类型"},{default:t(()=>[e(h,{type:Q(p.value.template_code),size:"small"},{default:t(()=>[n(r(H(p.value.template_code)),1)]),_:1},8,["type"])]),_:1}),e(x,{label:"国家/语言"},{default:t(()=>[e(h,{size:"small"},{default:t(()=>[n(r(p.value.country_code.toUpperCase()),1)]),_:1})]),_:1}),e(x,{label:"模板名称",span:2},{default:t(()=>[n(r(p.value.template_name),1)]),_:1}),e(x,{label:"模板说明",span:2},{default:t(()=>[n(r(p.value.description||"-"),1)]),_:1}),e(x,{label:"状态"},{default:t(()=>[e(h,{type:p.value.is_active?"success":"danger"},{default:t(()=>[n(r(p.value.is_active?"启用":"禁用"),1)]),_:1},8,["type"])]),_:1}),e(x,{label:"更新时间"},{default:t(()=>[n(r(p.value.updated_at),1)]),_:1})]),_:1}),e(Te,null,{default:t(()=>[...l[29]||(l[29]=[n("短信内容预览",-1)])]),_:1}),b("div",al,[b("div",ol,r(p.value.content),1),b("div",nl,[b("span",null,"字符数: "+r(p.value.content.length),1),p.value.content.length>160?(c(),k("span",sl," (可能拆分为 "+r(Math.ceil(p.value.content.length/160))+" 条) ",1)):K("",!0)])])])):K("",!0)]),_:1},8,["modelValue"])])}}}),_l=Ze(rl,[["__scopeId","data-v-d2a7da4b"]]);export{_l as default};
