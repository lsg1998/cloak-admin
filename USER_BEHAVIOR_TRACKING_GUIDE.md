# 后台管理 - 用户行为轨迹功能使用指南

## 📋 功能说明

在后台管理的"访客IP列表"页面中，新增了"用户轨迹"功能，可以查看每个IP的用户行为详情。

---

## 🎯 功能特性

### 1. 用户轨迹摘要
- 在每个IP记录中显示停留时长
- 默认显示最近一次访问的停留时长
- 如"停留 5分30秒"

### 2. 详细时间线查看
点击"查看详情"按钮可以查看完整的用户操作时间线，包括：
- 进入页面
- 滚动浏览
- 点击商品图片
- 选择SKU（颜色、尺码）
- 选择地址（省市区）
- 填写表单
- 提交订单
- 订单结果

### 3. 数据来源自动切换
- **优先从Redis查询**（实时数据，速度快）
- **Redis无数据时查MySQL**（历史数据）
- 自动显示数据来源标签

---

## 🖥️ 使用方法

### 步骤1：访问访客IP列表

登录后台管理 → 数据统计 → 访客IP列表

### 步骤2：查看停留时长

在列表中可以看到每个IP的"用户轨迹"区域：
```
用户轨迹
⏰ 停留 5分30秒
[查看详情]
```

### 步骤3：查看详细时间线

点击"查看详情"按钮，弹窗显示：

**摘要信息：**
- Session ID
- 数据来源（Redis/MySQL）
- 进入时间
- 离开时间
- 停留时长
- 操作次数

**操作时间线：**
```
2025-01-03 22:45:54
✓ 进入页面

2025-01-03 22:46:00
📜 滚动页面 (30%)

2025-01-03 22:46:10
🎨 选择规格: 红色

2025-01-03 22:46:20
📍 选择省份: 東京都

2025-01-03 22:46:30
📍 选择城市: 新宿区

2025-01-03 22:46:40
✏️ 填写姓名

2025-01-03 22:46:50
📞 填写电话

2025-01-03 22:47:00
🛒 点击购买按钮

2025-01-03 22:47:05
📝 提交订单

2025-01-03 22:47:10
✅ 订单成功: ORD20250103001
```

---

## 🎨 界面说明

### 用户轨迹区域
```
┌─────────────────────────────────┐
│ 用户轨迹                         │
│ ⏰ 停留 5分30秒  [查看详情 →]   │
└─────────────────────────────────┘
```

### 时间线弹窗
```
┌────────────────────────────────────────┐
│ 用户行为轨迹                      [✕]   │
├────────────────────────────────────────┤
│ Session ID: 1759xxx_xxx                │
│ 数据来源: Redis (实时)                  │
│ 进入时间: 2025-01-03 22:45:54          │
│ 离开时间: 2025-01-03 22:47:10          │
│ 停留时长: 5分30秒                      │
│ 操作次数: 12 次                         │
├────────────────────────────────────────┤
│ 📅 2025-01-03 22:45:54                 │
│ ✓ 进入页面                              │
│                                        │
│ 📅 2025-01-03 22:46:00                 │
│ 📜 滚动页面 (30%)                       │
│ ...                                    │
└────────────────────────────────────────┘
```

---

## 🎯 操作类型说明

| 图标 | 操作类型 | 说明 |
|------|---------|------|
| ✓ | 进入页面 | 用户访问产品页面 |
| ℹ | 离开页面 | 用户关闭或离开 |
| 📜 | 滚动页面 | 查看产品详情 |
| 🖼️ | 点击图片 | 查看产品图片 |
| 🎨 | 选择规格 | 选择颜色/尺码 |
| 📍 | 选择省份 | 填写收货地址 |
| 📍 | 选择城市 | 填写收货城市 |
| 📍 | 选择地区 | 填写收货地区 |
| ✏️ | 填写姓名 | 填写收货人 |
| 📞 | 填写电话 | 填写联系方式 |
| 📧 | 填写邮箱 | 填写电子邮箱 |
| 🛒 | 点击购买 | 点击购买按钮 |
| 📝 | 提交订单 | 提交订单 |
| ✅ | 订单成功 | 订单提交成功 |
| ❌ | 订单失败 | 订单提交失败 |

---

## 🔍 数据来源说明

### Redis (实时数据)
- 标签：🟢 Redis (实时)
- 特点：最新的用户行为，还未迁移到数据库
- 保存时间：48小时

### MySQL (历史数据)
- 标签：🔵 MySQL (历史)
- 特点：已经持久化的历史数据
- 保存时间：永久

---

## 📊 业务价值

### 1. 了解用户行为
- 查看用户在页面上的完整操作路径
- 了解用户关注哪些信息
- 发现用户的浏览习惯

### 2. 优化转化率
- 识别用户流失点
- 发现表单填写中的问题
- 优化页面布局和交互

### 3. 分析访问质量
- 区分真实用户和爬虫
- 评估访客的购买意向
- 识别高价值访客

### 4. 客户服务
- 查看用户操作历史
- 帮助解决订单问题
- 提供个性化服务

---

## 💡 使用技巧

### 1. 快速识别高价值用户
查看停留时长较长（>3分钟）且有表单填写的用户

### 2. 分析流失原因
查看在哪一步骤用户离开：
- 滚动后离开 → 产品吸引力不足
- 选择规格后离开 → 规格/价格问题
- 填写表单后离开 → 表单设计问题
- 提交订单失败 → 技术问题

### 3. 对比不同用户行为
对比转化用户和流失用户的操作路径差异

---

## 🔧 技术说明

### API接口

#### 1. 获取用户行为摘要
```
GET /api/admin/user-behavior/summary?ip={ip}
```

#### 2. 获取详细时间线
```
GET /api/admin/user-behavior/timeline?sessionId={sessionId}&ip={ip}&productId={productId}&date={date}
```

### 查询逻辑

```
用户点击"查看详情"
  ↓
优先查询Redis
  ├─ 有数据 → 返回实时数据
  └─ 无数据 → 查询MySQL历史数据
```

### 性能优化

- 批量加载摘要数据（每页最多20条）
- Redis查询优先（<1ms）
- MySQL查询降级（<10ms）
- 异步加载，不阻塞页面

---

## ❓ 常见问题

### Q1: 为什么有些IP没有轨迹数据？
A: 可能的原因：
- 用户刚访问，还未触发数据上报
- 用户没有进行操作就离开了
- 该IP是爬虫，被过滤了

### Q2: 数据多久更新一次？
A: 
- Redis实时更新（用户离开页面时上报）
- MySQL每30分钟同步一次

### Q3: 历史数据能保存多久？
A:
- Redis: 48小时自动过期
- MySQL: 永久保存

### Q4: 停留时长不准确？
A:
- 如果用户多次刷新页面，显示的是最后一次的时长
- 如果用户切换标签页但未关闭，时长会继续计算

---

## 📝 更新日志

**v1.0.0** (2025-01-03)
- ✅ 新增用户轨迹摘要显示
- ✅ 新增时间线详情查看
- ✅ 支持Redis/MySQL双数据源
- ✅ 支持15+种操作类型
- ✅ 美化时间线展示

---

**开发者：** AI Assistant  
**更新时间：** 2025-01-03  
**版本：** 1.0.0

